#!/bin/bash

set -e  # Выход при ошибке

SOCKET_PATH="/tmp/mpv-socket"
LOG_FILE="/var/log/dsign/mpv-manager.log"

# Создаем директорию для логов
mkdir -p /var/log/dsign
chown dsign:dsign /var/log/dsign

log() {
    echo "$(date '+%Y-%m-%d %H:%M:%S') - $1" >> "$LOG_FILE"
}

case "$1" in
    start)
        log "Starting MPV cleanup"
        # Очистка перед запуском
        pkill -9 mpv >/dev/null 2>&1 || true
        rm -f "$SOCKET_PATH" || true
        ;;
    stop)
        log "Stopping MPV processes"
        # Сначала корректное завершение
        pkill -TERM mpv >/dev/null 2>&1 || true
        sleep 1
        # Затем принудительное
        pkill -9 mpv >/dev/null 2>&1 || true
        rm -f "$SOCKET_PATH" || true
        ;;
    *)
        echo "Usage: $0 {start|stop}"
        exit 1
        ;;
esac

log "Operation $1 completed successfully"
exit 0
